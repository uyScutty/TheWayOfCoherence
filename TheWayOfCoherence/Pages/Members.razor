@page "/members"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Application.Abstractions.Contracts.Gateways
@using Application.Features.Posts.Dtos
@using Application.Features.Posts.Queries
@using MediatR
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IChatService ChatService
@inject IJSRuntime JSRuntime
@inject IMediator Mediator
@attribute [Authorize]
@layout MainLayout

<PageTitle>Medlemsomr√•de - The Way of Coherence</PageTitle>

<div class="members-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-card">
            <h3 class="sidebar-title">üìö Indholdstyper</h3>
            <div class="content-filters">
                @foreach (var type in ContentTypes)
                {
                    <button class="filter-btn @(CurrentFilter == type.Key ? "active" : "")"
                            @onclick="@(() => FilterContent(type.Key))">
                        <span>@type.Value</span>
                        <span class="filter-count">@AllContent.Count(c => c.Type == type.Key)</span>
                    </button>
                }
            </div>
        </div>

        <div class="sidebar-card">
            <h3 class="sidebar-title">üè∑Ô∏è Kategorier</h3>
            <div class="content-filters">
                @foreach (var category in Categories)
                {
                    <button class="filter-btn @(CurrentCategory == category.Key ? "active" : "")"
                            @onclick="@(() => FilterByCategory(category.Key))">
                        <span>@category.Value</span>
                    </button>
                }
            </div>
        </div>

        <div class="sidebar-card">
            <h3 class="sidebar-title">üìä Din Aktivitet</h3>
            <div style="display:flex;flex-direction:column;gap:0.75rem;">
                <div><small>Medlem siden</small><br /><b>@MemberSince.ToString("dd MMM yyyy")</b></div>
                <div><small>Kurser</small><br /><b>@CompletedCourses af @TotalCourses</b></div>
                <div><small>Artikler l√¶st</small><br /><b>@ReadArticles</b></div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <section class="welcome-section">
            <h1>Velkommen, @UserName! üåü</h1>
            <p>Udforsk eksklusivt indhold og din l√¶ringsrejse.</p>
            <div class="member-stats">
                <div class="stat-item">
                    <span class="stat-value">@DaysAsMember</span>
                    <span class="stat-label">Dage som medlem</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">@ProgressPercentage%</span>
                    <span class="stat-label">Kurser gennemf√∏rt</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">@HoursWatched</span>
                    <span class="stat-label">Timer set</span>
                </div>
            </div>
        </section>

        <div class="progress-card">
            <div class="progress-header">
                <h3 class="progress-title">Din L√¶ringsrejse</h3>
                <span style="color:var(--primary-color);font-weight:600;">@ProgressPercentage% Gennemf√∏rt</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width:@ProgressPercentage%"></div>
            </div>
        </div>

        <h2 style="margin-bottom:1.5rem;color:var(--primary-color);">‚ú® Fremh√¶vet Indhold</h2>
        <div class="content-grid">
            @foreach (var content in FilteredContent)
            {
                <article class="content-card" @key="content.Id">
                    <div class="content-thumbnail">
                        @content.Icon
                        <span class="content-type-badge type-@content.Type">@content.TypeLabel</span>
                        @if (content.IsMembersOnly)
                        {
                            <span class="members-only-badge">üîí KUN MEDLEMMER</span>
                        }
                    </div>
                    <div class="content-body">
                        <div class="content-category">@content.Category</div>
                        <h3 class="content-title">@content.Title</h3>
                        <p class="content-excerpt">@content.Excerpt</p>
                        <div class="content-meta">
                            <span>@content.Duration ‚Ä¢ @content.PublishedDate.ToString("MMM yyyy")</span>
                            <div class="content-actions">
                                <button class="action-btn" @onclick="@(() => LikeContent(content.Id))">‚ù§Ô∏è @content.Likes</button>
                                <button class="action-btn" @onclick="@(() => CommentContent(content.Id))">üí¨ @content.Comments</button>
                            </div>
                        </div>
                    </div>
                </article>
            }
        </div>
    </main>
</div>

<!-- Chatbot -->
<div class="chatbot-container @(IsChatOpen ? "open" : "")" id="chatbot">
    <div class="chatbot-header">
        <div class="chatbot-title">
            <span>ü§ñ</span>
            <span>@(IsAdmin ? "Owner AI Assistent" : "Patient AI Assistent")</span>
        </div>
        <div class="chatbot-status">
            <span class="status-dot"></span>
            <span>@(IsAiOnline ? "Online" : "Offline")</span>
        </div>
    </div>
    <div class="chatbot-body" @ref="chatBodyRef">
        @foreach (var msg in ChatMessages)
        {
            <div class="chat-message @(msg.IsBot ? "message-bot" : "message-user")">
                @((MarkupString)msg.Text)
            </div>
        }
        @if (IsLoading)
        {
            <div class="chat-message message-bot">
                <em>Skriver...</em>
            </div>
        }
    </div>
    <div class="chatbot-footer">
        <input type="text" 
               class="chat-input" 
               placeholder="Skriv besked..." 
               @bind="CurrentMessage" 
               @bind:event="oninput"
               @onkeydown="HandleKeyPress"
               disabled="@IsLoading" />
        <button class="send-btn" @onclick="SendMessage" disabled="@IsLoading">
            @(IsLoading ? "..." : "Send")
        </button>
    </div>
</div>

<button class="chat-toggle @(IsChatOpen ? "active" : "")" @onclick="ToggleChat">
    @(IsChatOpen ? "‚úï" : "üí¨")
</button>

@code {
    private string UserName = "Maria";
    private DateTime MemberSince = DateTime.Now.AddDays(-27);
    private int CompletedCourses = 2, TotalCourses = 3, ReadArticles = 15, HoursWatched = 12;
    private int ProgressPercentage = 65;
    private int DaysAsMember => (DateTime.Now - MemberSince).Days;

    private bool IsAdmin = false;
    private string CurrentFilter = "all";
    private string CurrentCategory = "";

    private bool IsChatOpen = false;
    private bool IsAiOnline = true;
    private bool IsLoading = false;
    private string CurrentMessage = "";
    private ElementReference chatBodyRef;
    private List<ChatMessage> ChatMessages = new();
    private string UserRole => IsAdmin ? "owner" : "patient";

    private List<Content> AllContent = new();
    private List<Content> FilteredContent = new();

    private Dictionary<string, string> Categories = new();

    private Dictionary<string, string> ContentTypes = new() {
        { "all", "Alt Indhold" }, { "video", "üé• Videoer" },
        { "blog", "üìù Blogs" }, { "audio", "üéß Lyd" },
        { "course", "üéì Kurser" }
    };

    protected override async Task OnInitializedAsync()
    {
        // Hent bruger info og rolle
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // Brug claims direkte for at undg√• DbContext threading issues
            UserName = user.Identity.Name ?? user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "Bruger";
            IsAdmin = user.IsInRole("Admin");
        }

        // Redirect admin til dashboard
        if (IsAdmin)
        {
            Navigation.NavigateTo("/admin/dashboard", forceLoad: true);
            return;
        }

        // Load content
        await LoadContentAsync();

        // Add welcome message til chatbot
        ChatMessages.Add(new ChatMessage
        {
            Id = 1,
            IsBot = true,
            Text = "Hej! Jeg er din personlige patient-assistent. Jeg kan hj√¶lpe dig med sp√∏rgsm√•l om sundhed, behandling og velv√¶re. Hvad kan jeg hj√¶lpe dig med i dag?"
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || IsChatOpen)
        {
            await ScrollToBottom();
        }
    }


    private async Task LoadContentAsync()
    {
        var posts = await Mediator.Send(new ListPostsQuery(isPublished: true));

        AllContent = posts.Select(MapPostToContent).ToList();
        Categories = AllContent
            .Where(c => !string.IsNullOrWhiteSpace(c.Category))
            .GroupBy(c => c.Category)
            .OrderBy(g => g.Key)
            .ToDictionary(g => g.Key, g => g.Key);

        FilteredContent = GetFilteredContent(CurrentFilter, CurrentCategory);
    }

    private List<Content> GetFilteredContent(string typeKey, string categoryKey)
    {
        IEnumerable<Content> query = AllContent;

        if (!string.IsNullOrWhiteSpace(typeKey) && typeKey != "all")
        {
            query = query.Where(c => string.Equals(c.Type, typeKey, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(categoryKey))
        {
            query = query.Where(c => string.Equals(c.Category, categoryKey, StringComparison.OrdinalIgnoreCase));
        }

        return query.ToList();
    }

    private Content MapPostToContent(PostDto dto)
    {
        var type = InferType(dto.Category);
        return new Content
        {
            Id = dto.Id,
            Type = type,
            TypeLabel = type switch
            {
                "video" => "VIDEO",
                "audio" => "LYD",
                "course" => "KURSUS",
                _ => "ARTIKEL"
            },
            Icon = GetIconForCategory(dto.Category),
            Category = dto.Category,
            Title = dto.Title,
            Excerpt = BuildExcerpt(dto.Body, 160),
            Duration = CalculateDuration(dto.Body),
            PublishedDate = dto.CreatedAt,
            IsMembersOnly = dto.IsPaywalled,
            Likes = 0,
            Comments = 0
        };
    }

    private static string InferType(string category)
    {
        var value = category?.ToLowerInvariant() ?? string.Empty;
        if (value.Contains("video")) return "video";
        if (value.Contains("audio")) return "audio";
        if (value.Contains("kursus") || value.Contains("course")) return "course";
        return "blog";
    }

    private static string GetIconForCategory(string category)
    {
        var value = category?.ToLowerInvariant() ?? string.Empty;
        if (value.Contains("meditation") || value.Contains("spiritual"))
            return "üßò";
        if (value.Contains("video"))
            return "üé•";
        if (value.Contains("sundhed") || value.Contains("health"))
            return "üåø";
        if (value.Contains("√∏konomi") || value.Contains("bitcoin"))
            return "üí∞";
        return "üìñ";
    }

    private static string BuildExcerpt(string body, int maxLength)
    {
        if (string.IsNullOrWhiteSpace(body))
            return "...";

        var plainText = System.Text.RegularExpressions.Regex.Replace(body, "<.*?>", string.Empty);
        plainText = System.Text.RegularExpressions.Regex.Replace(plainText, @"\[.*?\]\(.*?\)", string.Empty);

        if (plainText.Length <= maxLength)
            return plainText;

        return plainText.Substring(0, maxLength).TrimEnd() + "...";
    }

    private static string CalculateDuration(string body)
    {
        if (string.IsNullOrWhiteSpace(body))
        {
            return "3 min";
        }

        var minutes = Math.Clamp(body.Length / 600, 3, 20);
        return $"{minutes} min";
    }

    private void FilterContent(string type)
    {
        CurrentFilter = type;
        FilteredContent = GetFilteredContent(CurrentFilter, CurrentCategory);
    }

    private void FilterByCategory(string category)
    {
        CurrentCategory = CurrentCategory == category ? "" : category;
        FilteredContent = GetFilteredContent(CurrentFilter, CurrentCategory);
    }

    private void LikeContent(Guid id) => AllContent.First(c => c.Id == id).Likes++;

    private void CommentContent(Guid id) => Navigation.NavigateTo($"/content/{id}#comments");

    private void ToggleChat()
    {
        IsChatOpen = !IsChatOpen;
        if (IsChatOpen)
        {
            _ = ScrollToBottom();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(CurrentMessage) || IsLoading)
            return;

        var userMessage = CurrentMessage.Trim();
        CurrentMessage = "";

        // Add user message
        ChatMessages.Add(new ChatMessage
        {
            Id = ChatMessages.Count + 1,
            IsBot = false,
            Text = userMessage
        });

        IsLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            var response = await ChatService.SendChatAsync(UserRole, userMessage);
            
            ChatMessages.Add(new ChatMessage
            {
                Id = ChatMessages.Count + 1,
                IsBot = true,
                Text = response
            });
        }
        catch (Exception ex)
        {
            var errorMessage = $"Beklager, der opstod en fejl: {ex.Message}";
            if (ex.InnerException != null)
            {
                errorMessage += $" ({ex.InnerException.Message})";
            }
            ChatMessages.Add(new ChatMessage
            {
                Id = ChatMessages.Count + 1,
                IsBot = true,
                Text = errorMessage
            });
            Console.WriteLine($"Chatbot fejl: {ex}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !IsLoading)
        {
            await SendMessage();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", 
                "setTimeout(() => { const el = document.querySelector('.chatbot-body'); if (el) el.scrollTop = el.scrollHeight; }, 100);");
        }
        catch { }
    }

    public class Content
    {
        public Guid Id { get; set; }
        public string Type { get; set; } = "";
        public string TypeLabel { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Category { get; set; } = "";
        public string Title { get; set; } = "";
        public string Excerpt { get; set; } = "";
        public string Duration { get; set; } = "";
        public DateTime PublishedDate { get; set; }
        public bool IsMembersOnly { get; set; }
        public int Likes { get; set; }
        public int Comments { get; set; }
    }

    public class ChatMessage
    {
        public int Id { get; set; }
        public bool IsBot { get; set; }
        public string Text { get; set; } = "";
    }
}
