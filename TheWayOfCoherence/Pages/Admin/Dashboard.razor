@page "/admin/dashboard"
@using Application.Abstractions.Contracts.Gateways
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@layout MainLayout
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Admin Dashboard - The Way of Coherence</PageTitle>

<div class="admin-dashboard-container">
    <div class="admin-header">
        <h1>üëë Admin Dashboard</h1>
        <p>Administrer dit indhold, medlemmer og brug din AI-assistent til at hj√¶lpe med administrative opgaver.</p>
    </div>

    <div class="admin-content">
        <div class="info-card" style="margin-bottom: 2rem;">
            <h3>üõ†Ô∏è Hvad kan jeg hj√¶lpe med?</h3>
            <ul>
                <li>Administrative opgaver og sp√∏rgsm√•l</li>
                <li>Vejledning om indholdsstyring</li>
                <li>Hj√¶lp med medlemsadministration</li>
                <li>Generelle r√•d om platformen</li>
            </ul>
        </div>

        <div class="info-card">
            <h3>üìù Indholdsstyring</h3>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <a href="/admin/posts/create" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                    ‚ûï Opret Ny Post
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot -->
<div class="chatbot-container @(IsChatOpen ? "open" : "")" id="chatbot">
    <div class="chatbot-header">
        <div class="chatbot-title">
            <span>ü§ñ</span>
            <span>Admin AI Assistent</span>
        </div>
        <div class="chatbot-status">
            <span class="status-dot"></span>
            <span>@(IsAiOnline ? "Online" : "Offline")</span>
        </div>
    </div>
    <div class="chatbot-body" @ref="chatBodyRef">
        @foreach (var msg in ChatMessages)
        {
            <div class="chat-message @(msg.IsBot ? "message-bot" : "message-user")">
                @((MarkupString)msg.Text)
            </div>
        }
        @if (IsLoading)
        {
            <div class="chat-message message-bot">
                <em>Skriver...</em>
            </div>
        }
    </div>
    <div class="chatbot-footer">
        <input type="text" 
               class="chat-input" 
               placeholder="Skriv besked..." 
               @bind="CurrentMessage" 
               @bind:event="oninput"
               @onkeydown="HandleKeyPress"
               disabled="@IsLoading" />
        <button class="send-btn" @onclick="SendMessage" disabled="@IsLoading">
            @(IsLoading ? "..." : "Send")
        </button>
    </div>
</div>

<button class="chat-toggle @(IsChatOpen ? "active" : "")" @onclick="ToggleChat">
    @(IsChatOpen ? "‚úï" : "üí¨")
</button>

@code {
    [Inject] private IChatService ChatService { get; set; } = null!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;

    private bool IsChatOpen = false;
    private bool IsAiOnline = true;
    private bool IsLoading = false;
    private string CurrentMessage = "";
    private ElementReference chatBodyRef;
    private List<ChatMessage> ChatMessages = new();

    private const string UserRole = "owner";

    protected override async Task OnInitializedAsync()
    {
        // Add welcome message med "Hej Chef!"
        ChatMessages.Add(new ChatMessage
        {
            Id = 1,
            IsBot = true,
            Text = "Hej Chef! üëë Jeg er din personlige AI-assistent. Jeg kan hj√¶lpe dig med administrative opgaver, indholdsstyring og generelle sp√∏rgsm√•l om platformen. Hvad kan jeg hj√¶lpe dig med i dag?"
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || IsChatOpen)
        {
            await ScrollToBottom();
        }
    }

    private void ToggleChat()
    {
        IsChatOpen = !IsChatOpen;
        if (IsChatOpen)
        {
            _ = ScrollToBottom();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(CurrentMessage) || IsLoading)
            return;

        var userMessage = CurrentMessage.Trim();
        CurrentMessage = "";

        // Add user message
        ChatMessages.Add(new ChatMessage
        {
            Id = ChatMessages.Count + 1,
            IsBot = false,
            Text = userMessage
        });

        IsLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            var response = await ChatService.SendChatAsync(UserRole, userMessage);
            
            ChatMessages.Add(new ChatMessage
            {
                Id = ChatMessages.Count + 1,
                IsBot = true,
                Text = response
            });
        }
        catch (Exception ex)
        {
            var errorMessage = $"Beklager, der opstod en fejl: {ex.Message}";
            if (ex.InnerException != null)
            {
                errorMessage += $" ({ex.InnerException.Message})";
            }
            ChatMessages.Add(new ChatMessage
            {
                Id = ChatMessages.Count + 1,
                IsBot = true,
                Text = errorMessage
            });
            Console.WriteLine($"Chatbot fejl: {ex}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !IsLoading)
        {
            await SendMessage();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", 
                "setTimeout(() => { const el = document.querySelector('.chatbot-body'); if (el) el.scrollTop = el.scrollHeight; }, 100);");
        }
        catch { }
    }

    public class ChatMessage
    {
        public int Id { get; set; }
        public bool IsBot { get; set; }
        public string Text { get; set; } = "";
    }
}

