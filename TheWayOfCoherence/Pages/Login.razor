@page "/login"
@layout MainLayout
@using System.Net.Http
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Log Ind - The Way of Coherence</PageTitle>

<div class="login-container">
    <div class="login-card">
        <h2>Log Ind</h2>
        <p>Log ind for at få adgang til dit medlemsområde</p>

        <EditForm Model="@LoginForm" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger" style="padding: 0.75rem; margin-bottom: 1rem; background: #f8d7da; color: #721c24; border-radius: var(--border-radius);">
                    @ErrorMessage
                </div>
            }

            <div class="form-group">
                <label>Email:</label>
                <InputText type="email" class="form-control" @bind-Value="LoginForm.Email" disabled="@IsLoggingIn" />
            </div>

            <div class="form-group">
                <label>Password:</label>
                <InputText type="password" class="form-control" @bind-Value="LoginForm.Password" disabled="@IsLoggingIn" />
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;" disabled="@IsLoggingIn">
                @(IsLoggingIn ? "Logger ind..." : "Log Ind")
            </button>
        </EditForm>

        <div style="margin-top: 1.5rem; text-align: center;">
            <p>Har du ikke en konto? <a href="/" @onclick="@(() => Navigation.NavigateTo("/"))">Bliv medlem her</a></p>
        </div>
    </div>
</div>

@code {
    private LoginFormModel LoginForm = new();
    private string ErrorMessage = "";
    private bool IsLoggingIn = false;

    private async Task HandleLogin()
    {
        ErrorMessage = "";

        if (string.IsNullOrWhiteSpace(LoginForm.Email) || string.IsNullOrWhiteSpace(LoginForm.Password))
        {
            ErrorMessage = "Email og password skal udfyldes.";
            return;
        }

        IsLoggingIn = true;
        StateHasChanged();

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            httpClient.BaseAddress = new Uri(Navigation.BaseUri);
            
            var response = await httpClient.PostAsJsonAsync("/api/auth/login", new
            {
                Email = LoginForm.Email,
                Password = LoginForm.Password
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (result != null && result.Success && !string.IsNullOrEmpty(result.RedirectUrl))
                {
                    // Vent lidt for at sikre at sign-in cookie er sat
                    await Task.Delay(500);
                    
                    // Brug JavaScript location.href for at sikre fuld page reload og korrekt authentication state
                    await JSRuntime.InvokeVoidAsync("eval", $"window.location.href = '{result.RedirectUrl}';");
                    return;
                }
            }
            else
            {
                var errorResult = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                ErrorMessage = errorResult?.Error ?? "Fejl ved login.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Fejl ved login: {ex.Message}";
        }
        finally
        {
            IsLoggingIn = false;
            StateHasChanged();
        }
    }

    public class LoginFormModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }

    private class LoginResponse
    {
        public bool Success { get; set; }
        public string? RedirectUrl { get; set; }
    }

    private class ErrorResponse
    {
        public string? Error { get; set; }
    }
}
