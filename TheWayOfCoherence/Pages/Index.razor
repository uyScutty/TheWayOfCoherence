@page "/"
@layout MainLayout
@using Application.Features.Users.Commands
@using MediatR
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject Application.Abstractions.Contracts.Gateways.IChatService ChatService
@inject IJSRuntime JSRuntime
@inject IMediator Mediator
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>The Way of Coherence</PageTitle>

<!-- Hero Section -->
<section class="hero" id="home">
    <h1>VEJEN TIL KOH√ÜRENS</h1>
    <p class="hero-subtitle">Mestring af ens milj√∏ er frihed og giver mere energi</p>
    <p class="hero-description">
        Intentionen med denne hjemmeside er at assistere udviklingen af vores f√¶lles bevidsthed
        med bare f√∏dder i jorden og kroppen i solen. Jeg tror p√•, at menneskeheden kan trives
        og ikke bare overleve.
    </p>
    <button class="btn btn-primary" @onclick="@(() => ScrollToSection("services"))">Udforsk Mere</button>
</section>

<!-- About -->
<section class="section" id="about">
    <h2 class="section-title">Hvad er Koh√¶rens?</h2>
    <div class="cards-grid">
        @foreach (var card in AboutCards)
        {
            <div class="card" @key="card.Id">
                <div class="card-icon">@card.Icon</div>
                <h3>@card.Title</h3>
                <p>@card.Description</p>
            </div>
        }
    </div>
</section>

<!-- Services -->
<section class="section" id="services">
    <h2 class="section-title">Mine Tjenester</h2>
    <div class="cards-grid">
        @foreach (var service in Services)
        {
            <div class="card" @key="service.Id">
                <div class="card-icon">@service.Icon</div>
                <h3>@service.Title</h3>
                <p>@service.Description</p>
            </div>
        }
    </div>
</section>

<!-- Blog -->
<section class="section" id="blog">
    <h2 class="section-title">Seneste Blog Indl√¶g</h2>
    <div class="blog-grid">
        @foreach (var post in BlogPosts)
        {
            <article class="blog-card" @key="post.Id">
                <div class="blog-image">@post.Icon</div>
                <div class="blog-content">
                    <span class="blog-category">@post.Category</span>
                    <h3 class="blog-title">@post.Title</h3>
                    <p class="blog-excerpt">@post.Excerpt</p>
                    <a href="/blog/@post.Id" class="read-more">L√¶s mere ‚Üí</a>
                </div>
            </article>
        }
    </div>
</section>

<!-- AI Bots -->
<section class="ai-section">
    <h2 class="section-title">AI Assistenter @(AiBotsEnabled ? "(Aktive)" : "(Kommer Snart)")</h2>
    <div class="ai-bots">
        @foreach (var bot in AiBots)
        {
            <div class="ai-bot" @key="bot.Id">
                <div class="ai-bot-icon">@bot.Icon</div>
                <h3>@bot.Name</h3>
                <p>@bot.Description</p>
                <button class="btn btn-secondary" disabled="@(!bot.IsActive)" @onclick="@(() => ActivateBot(bot.Id))">
                    @(bot.IsActive ? "Aktiver" : "Kommer Snart")
                </button>
            </div>
        }
    </div>
</section>

<!-- Membership -->
<section class="membership" id="membership">
    <h2>Bliv Medlem af F√¶llesskabet</h2>
    <p>
        Jeg har valgt at g√∏re siden gratis og uden reklamer, men hvis du s√¶tter pris p√• indholdet,
        kan du blive medlem og blive notificeret ved nye posts.
    </p>

    <div class="membership-benefits">
        <div class="benefit">
            <span class="benefit-icon">‚úì</span>
            <span>Adgang til eksklusivt indhold</span>
        </div>
        <div class="benefit">
            <span class="benefit-icon">‚úì</span>
            <span>Personlig AI-assistent</span>
        </div>
        <div class="benefit">
            <span class="benefit-icon">‚úì</span>
            <span>Notifikationer om nye posts</span>
        </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
        <button class="btn btn-primary" @onclick="ShowMembershipModal">Bliv Medlem Nu</button>
        <button class="btn btn-secondary" @onclick="@(() => Navigation.NavigateTo("/login"))">Log Ind</button>
    </div>

    @if (ShowBitcoinDonation)
    {
        <p style="margin-top: 2rem; color: var(--text-light);">
            St√∏t med Bitcoin Lightning: <br />
            <code style="background: var(--bg-light); padding: 0.5rem; border-radius: 4px;">
                @BitcoinAddress
            </code>
        </p>
    }
</section>

<!-- Chat Widget -->
<div class="chat-widget" @onclick="ToggleChat">
    üí¨
</div>

@if (IsChatOpen)
{
    <div class="chat-window">
        <div class="chat-messages">
            @foreach (var msg in ChatMessages)
            {
                <div class="chat-message">@msg</div>
            }
        </div>
        <input @bind="ChatInput" @bind:event="oninput" placeholder="Skriv en besked..." />
        <button class="btn btn-primary" @onclick="SendChat">Send</button>
    </div>
}

<!-- Membership Modal -->
@if (ShowMembershipModalDialog)
{
    <div class="modal-overlay" @onclick="CloseMembershipModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Bliv Medlem</h2>
                <button class="close-btn" @onclick="CloseMembershipModal">‚úï</button>
            </div>
            <div class="modal-body">
                <EditForm Model="@MembershipForm" OnValidSubmit="@HandleMembershipSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    @if (!string.IsNullOrEmpty(RegistrationErrorMessage))
                    {
                        <div class="alert alert-danger" style="padding: 0.75rem; margin-bottom: 1rem; background: #f8d7da; color: #721c24; border-radius: var(--border-radius);">
                            @RegistrationErrorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(RegistrationSuccessMessage))
                    {
                        <div class="alert alert-success" style="padding: 0.75rem; margin-bottom: 1rem; background: #d4edda; color: #155724; border-radius: var(--border-radius);">
                            @RegistrationSuccessMessage
                        </div>
                    }

                    <div class="form-group">
                        <label>Navn:</label>
                        <InputText class="form-control" @bind-Value="MembershipForm.Name" disabled="@IsRegistering" />
                    </div>

                    <div class="form-group">
                        <label>Email:</label>
                        <InputText type="email" class="form-control" @bind-Value="MembershipForm.Email" disabled="@IsRegistering" />
                    </div>

                    <div class="form-group">
                        <label>Password:</label>
                        <InputText type="password" class="form-control" @bind-Value="MembershipForm.Password" disabled="@IsRegistering" />
                    </div>

                    <div class="form-group">
                        <label>Bekr√¶ft Password:</label>
                        <InputText type="password" class="form-control" @bind-Value="MembershipForm.ConfirmPassword" disabled="@IsRegistering" />
                    </div>

                    <button type="submit" class="btn btn-primary" disabled="@IsRegistering">
                        @(IsRegistering ? "Opretter..." : "Tilmeld")
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
}
@code {
    // ---- Simple state ----
    private bool ShowMembershipModalDialog = false;
    private bool ShowChatWidget = true;
    private bool ShowBitcoinDonation = true;
    private bool AiBotsEnabled = false;
    // Chat state
    private bool IsChatOpen = false;
    private string ChatInput = "";
    private List<string> ChatMessages = new();


    private string BitcoinAddress = "lightning:lnbc...";
    private string ContactEmail = "info@wayofcoherence.com";

    private MembershipFormModel MembershipForm = new();

    // ---- Data lists (no fancy C# features) ----
    private List<AboutCard> AboutCards = new()
    {
        new AboutCard { Id = 1, Icon = "üíñ", Title = "Hjerte-Hjerne Synkronisering", Description = "Koh√¶rens er en tilstand af synkronisering..." },
        new AboutCard { Id = 2, Icon = "üåû", Title = "Naturlig Sundhed", Description = "L√¶r hvordan du bruger lys, vand og meditation..." },
        new AboutCard { Id = 3, Icon = "üßò", Title = "Bevidsthed & Spiritualitet", Description = "Udforsk vejen til h√∏jere bevidsthed..." }
    };

    private List<Service> Services = new()
    {
        new Service { Id = 1, Icon = "üî¨", Title = "Sundhedsvidenskab", Description = "Evidensbaseret tilgang til naturlig sundhed..." },
        new Service { Id = 2, Icon = "üåø", Title = "Holistisk Terapi", Description = "Refleksterapi og energiarbejde for balance..." },
        new Service { Id = 3, Icon = "üìö", Title = "Personlig Konsultation", Description = "En times konsultation kan arrangeres efter aftale..." }
    };

    private List<BlogPost> BlogPosts = new()
    {
        new BlogPost {
            Id = 1, Icon = "üì±", Category = "Teknologi & Sundhed",
            Title = "Sk√¶rm: B√∏rn med √•ben mund og lukkede √∏rer",
            Excerpt = "Udforsk hvordan sk√¶rmtid p√•virker vores b√∏rns udvikling...",
            PublishedDate = DateTime.Now.AddDays(-5)
        },
        new BlogPost {
            Id = 2, Icon = "üéóÔ∏è", Category = "Sundhed",
            Title = "Hvad jeg ville g√∏re med kr√¶ft",
            Excerpt = "En holistisk tilgang til forebyggelse og h√•ndtering...",
            PublishedDate = DateTime.Now.AddDays(-10)
        },
        new BlogPost {
            Id = 3, Icon = "üí∞", Category = "√òkonomi",
            Title = "Bitcoin & Pengerevolutionen",
            Excerpt = "Forst√• hvorfor decentraliseret valuta kan give frihed...",
            PublishedDate = DateTime.Now.AddDays(-15)
        }
    };

    private List<AiBot> AiBots = new()
    {
        new AiBot { Id = 1, Icon = "ü§ñ", Name = "Vejlednings Bot", Description = "Hj√¶lp til navigation", IsActive = false },
        new AiBot { Id = 2, Icon = "üë•", Name = "Medlems Assistent", Description = "Personlig vejledning", IsActive = false },
        new AiBot { Id = 3, Icon = "üîß", Name = "Admin Bot", Description = "Admin-opgaver", IsActive = false }
    };

    // ---- Methods used by markup ----
    private async Task ScrollToSection(string sectionId)
        => await JSRuntime.InvokeVoidAsync("scrollToElement", sectionId);

    private void ShowMembershipModal() => ShowMembershipModalDialog = true;
    private void CloseMembershipModal() => ShowMembershipModalDialog = false;
    private void OpenChat() { /* no-op for now */ }
    private void ActivateBot(int id) => Console.WriteLine($"Bot {id} aktiveret");
    private void ToggleChat()
    {
        IsChatOpen = !IsChatOpen;
    }

    private async Task SendChat()
    {
        if (string.IsNullOrWhiteSpace(ChatInput))
            return;

        // Tilf√∏j brugerbesked
        ChatMessages.Add($"Du: {ChatInput}");

        try
        {
            var response = await ChatService.SendChatAsync("guest", ChatInput);
            ChatMessages.Add($"Bot: {response}");
        }
        catch (Exception ex)
        {
            ChatMessages.Add($"Bot: Fejl ved AI: {ex.Message}");
        }

        ChatInput = ""; // ryd input
    }


    private bool IsRegistering = false;
    private string RegistrationErrorMessage = "";
    private string RegistrationSuccessMessage = "";

    private async Task HandleMembershipSubmit()
    {
        RegistrationErrorMessage = "";
        RegistrationSuccessMessage = "";

        // Validering
        if (string.IsNullOrWhiteSpace(MembershipForm.Name))
        {
            RegistrationErrorMessage = "Navn skal udfyldes.";
            return;
        }

        if (string.IsNullOrWhiteSpace(MembershipForm.Email) || !MembershipForm.Email.Contains("@"))
        {
            RegistrationErrorMessage = "Ugyldig email.";
            return;
        }

        if (string.IsNullOrWhiteSpace(MembershipForm.Password) || MembershipForm.Password.Length < 6)
        {
            RegistrationErrorMessage = "Password skal v√¶re mindst 6 tegn.";
            return;
        }

        if (MembershipForm.Password != MembershipForm.ConfirmPassword)
        {
            RegistrationErrorMessage = "Passwords matcher ikke.";
            return;
        }

        IsRegistering = true;
        StateHasChanged();

        try
        {
            var command = new UserSignupCommand(
                MembershipForm.Email,
                MembershipForm.Password,
                MembershipForm.Name
            );

            var userId = await Mediator.Send(command);

            RegistrationSuccessMessage = "Bruger oprettet! Du kan nu logge ind.";
            
            // Vent lidt og luk modal
            await Task.Delay(2000);
            ShowMembershipModalDialog = false;
            MembershipForm = new MembershipFormModel();
            
            // Naviger til login
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            RegistrationErrorMessage = $"Fejl ved oprettelse: {ex.Message}";
        }
        finally
        {
            IsRegistering = false;
            StateHasChanged();
        }
    }

    // ---- Plain POCOs (no records) ----
    public class AboutCard
    {
        public int Id { get; set; }
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
    }

    public class Service
    {
        public int Id { get; set; }
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
    }

    public class BlogPost
    {
        public int Id { get; set; }
        public string Icon { get; set; } = "";
        public string Category { get; set; } = "";
        public string Title { get; set; } = "";
        public string Excerpt { get; set; } = "";   // <-- used by markup
        public DateTime PublishedDate { get; set; }
    }

    public class AiBot
    {
        public int Id { get; set; }
        public string Icon { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public bool IsActive { get; set; }
    }

    public class MembershipFormModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
    }
}
